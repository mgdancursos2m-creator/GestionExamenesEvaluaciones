{% extends "base.html" %}

{% block title %}Agenda de Eventos - Administrador{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-calendar-alt"></i> Agenda de Eventos
        </h2>
    </div>

    <!-- Filtros de Mes y Año -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Filtrar Eventos</h6>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3 align-items-center">
                        <div class="col-auto">
                            <label for="month" class="form-label">Mes</label>
                            <select name="month" id="month" class="form-select" onchange="this.form.submit()">
                                {% for num, nombre in meses %}
                                    <option value="{{ num }}" {% if num == mes_actual %}selected{% endif %}>{{ nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-auto">
                            <label for="year" class="form-label">Año</label>
                            <select name="year" id="year" class="form-select" onchange="this.form.submit()">
                                {% for año in años %}
                                    <option value="{{ año }}" {% if año == año_actual %}selected{% endif %}>{{ año }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary mt-3">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Eventos -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        Eventos para {{ meses[mes_actual-1][1] }} de {{ año_actual }}
                        <span class="badge bg-light text-dark ms-2">{{ eventos|length }} eventos</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if eventos %}
                        <div class="events-container">
                            {% for evento in eventos %}
                            <div class="card event-card mb-3" style="border-left: 4px solid #007bff; transition: transform 0.2s ease-in-out;">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">{{ evento.curso_nombre|default('Sin nombre') }}</h5>
                                        <span class="badge bg-{{ 'success' if evento.estatus == 'abierto' else 'secondary' }}">
                                            {{ evento.estatus|upper }}
                                        </span>
                                    </div>
                                    
                                    <div class="event-details mb-3" style="background-color: #f8f9fa; padding: 12px; border-radius: 4px;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p class="card-text mb-1">
                                                    <strong>Fecha:</strong> 
                                                    {% if evento.fecha_evento %}
                                                        {{ evento.fecha_evento.strftime('%d/%m/%Y') }}
                                                    {% else %}
                                                        No especificada
                                                    {% endif %}
                                                </p>
                                                <p class="card-text mb-1">
                                                    <strong>Instructor:</strong> {{ evento.instructor_nombre|default('No asignado') }}
                                                </p>
                                            </div>
                                            <div class="col-md-6">
                                                <p class="card-text mb-1">
                                                    <strong>Alumnos:</strong> 
                                                    <span class="badge bg-info">{{ evento.total_alumnos|default(0) }}</span>
                                                </p>
                                            </div>
                                        </div>

                                        <!-- ESTADÍSTICAS -->
                                        <div class="event-stats mt-3" style="border-top: 1px solid #dee2e6; padding-top: 12px;">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="stat-item mb-2">
                                                        <small class="text-muted">Cuestionarios Contestados:</small>
                                                        <div class="fw-bold">
                                                            {{ evento.cuestionarios_contestados|default(0) }}/{{ evento.total_alumnos|default(0) }}
                                                            {% if evento.promedio_cuestionarios and evento.promedio_cuestionarios > 0 %}
                                                                <span class="badge bg-info ms-1">{{ evento.promedio_cuestionarios|default(0) }}/10</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="stat-item mb-2">
                                                        <small class="text-muted">Evaluaciones Registradas:</small>
                                                        <div class="fw-bold">
                                                            {{ evento.evaluaciones_contestadas|default(0) }}/{{ evento.total_alumnos|default(0) }}
                                                            {% if evento.promedio_evaluaciones and evento.promedio_evaluaciones > 0 %}
                                                                <span class="badge bg-warning ms-1">{{ evento.promedio_evaluaciones|default(0) }}/6</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Barra de Progreso -->
                                            <!-- GRÁFICAS DE CALIFICACIONES PROMEDIO -->
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <!-- Gráfica de Promedio de Cuestionarios -->
                                                    <div class="stat-item mb-3">
                                                        <small class="text-muted">Promedio Cuestionarios:</small>
                                                        <div class="d-flex align-items-center">
                                                            <div class="progress flex-grow-1 me-2" style="height: 12px; background-color: #e9ecef; border-radius: 6px;">
                                                                {% set promedio_cuestionarios = evento.promedio_cuestionarios|default(0) %}
                                                                <div class="progress-bar bg-success" role="progressbar" 
                                                                     style="width: {{ (promedio_cuestionarios / 10 * 100) if promedio_cuestionarios > 0 else 0 }}%; border-radius: 6px;"
                                                                     aria-valuenow="{{ promedio_cuestionarios }}" 
                                                                     aria-valuemin="0" 
                                                                     aria-valuemax="10">
                                                                </div>
                                                            </div>
                                                            <small class="text-muted fw-bold">
                                                                {{ "%.1f"|format(promedio_cuestionarios) }}/10
                                                            </small>
                                                        </div>
                                                        {% if promedio_cuestionarios > 0 %}
                                                        <small class="text-muted">
                                                            {{ convertir_escala_cuestionario(promedio_cuestionarios) }}
                                                        </small>
                                                        {% else %}
                                                        <small class="text-muted">Sin datos</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
            
                                                <div class="col-md-6">
                                                    <!-- Gráfica de Promedio de Evaluaciones -->
                                                    <div class="stat-item mb-3">
                                                        <small class="text-muted">Promedio Evaluaciones:</small>
                                                        <div class="d-flex align-items-center">
                                                            <div class="progress flex-grow-1 me-2" style="height: 12px; background-color: #e9ecef; border-radius: 6px;">
                                                                {% set promedio_evaluaciones = evento.promedio_evaluaciones|default(0) %}
                                                                <div class="progress-bar bg-warning" role="progressbar" 
                                                                     style="width: {{ (promedio_evaluaciones / 6 * 100) if promedio_evaluaciones > 0 else 0 }}%; border-radius: 6px;"
                                                                     aria-valuenow="{{ promedio_evaluaciones }}" 
                                                                     aria-valuemin="0" 
                                                                     aria-valuemax="6">
                                                                </div>
                                                            </div>
                                                            <small class="text-muted fw-bold">
                                                                {{ "%.1f"|format(promedio_evaluaciones) }}/6
                                                            </small>
                                                        </div>
                                                        {% if promedio_evaluaciones > 0 %}
                                                        <small class="text-muted">
                                                            {{ convertir_escala_evaluacion(promedio_evaluaciones) }}
                                                        </small>
                                                        {% else %}
                                                        <small class="text-muted">Sin datos</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- ESTADÍSTICAS DE PARTICIPACIÓN -->
                                            <div class="row mt-2">
                                                <div class="col-md-6">
                                                    <div class="stat-item">
                                                        <small class="text-muted">Participación en Cuestionarios:</small>
                                                        <div class="fw-bold">
                                                            {% set cuestionarios_contestados = evento.cuestionarios_contestados|default(0) %}
                                                            {% set total_alumnos = evento.total_alumnos|default(0) %}
                                                            {{ cuestionarios_contestados }}/{{ total_alumnos }}
                                                            <small class="text-muted">
                                                                {% if total_alumnos > 0 %}
                                                                    ({{ ((cuestionarios_contestados / total_alumnos) * 100)|round|int }}%)
                                                                {% else %}
                                                                    (0%)
                                                                {% endif %}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="stat-item">
                                                        <small class="text-muted">Participación en Evaluaciones:</small>
                                                        <div class="fw-bold">
                                                            {% set evaluaciones_contestadas = evento.evaluaciones_contestadas|default(0) %}
                                                            {% set total_alumnos = evento.total_alumnos|default(0) %}
                                                            {{ evaluaciones_contestadas }}/{{ total_alumnos }}
                                                            <small class="text-muted">
                                                                {% if total_alumnos > 0 %}
                                                                    ({{ ((evaluaciones_contestadas / total_alumnos) * 100)|round|int }}%)
                                                                {% else %}
                                                                    (0%)
                                                                {% endif %}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="event-actions">
                                        {% if not evento.instructor_id or evento.instructor_id == 'None' or evento.instructor_id == '' %}
                                        <button class="btn btn-outline-primary btn-sm asignar-instructor" 
                                                data-evento-id="{{ evento._id }}" 
                                                data-evento-nombre="{{ evento.curso_nombre|default('Evento sin nombre') }}">
                                            <i class="fas fa-user-plus"></i> Asignar Instructor
                                        </button>
                                        {% else %}
                                        <span class="badge bg-success">
                                          <i class="fas fa-check"></i> Instructor: {{ evento.instructor_nombre }}
                                        </span>
                                        {% endif %}
                                        <a href="{{ url_for('eventos.alumnos_evento', evento_id=evento._id) }}" 
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-users"></i> Alumnos
                                        </a>
                                        <button class="btn btn-outline-success btn-sm agregar-alumno-agenda" 
                                                data-evento-id="{{ evento._id }}"
                                                data-evento-nombre="{{ evento.curso_nombre }}">
                                            <i class="fas fa-user-plus"></i> Agregar Alumno
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="editarEvento('{{ evento._id }}')">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>
                                        {% if evento.estatus == 'abierto' %}
                                        <button class="btn btn-outline-danger btn-sm cerrar-evento" 
                                                data-evento-id="{{ evento._id|string }}"
                                                data-evento-nombre="{{ evento.curso_nombre }}"
                                                onclick="mostrarModalCerrarEvento('{{ evento._id|string }}', '{{ evento.curso_nombre }}')">
                                            <i class="fas fa-lock"></i> Cerrar Evento
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-calendar-times fa-2x mb-3"></i>
                            <h5>No hay eventos programados</h5>
                            <p class="mb-0">No se encontraron eventos para {{ meses[mes_actual-1][1] }} de {{ año_actual }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar Alumno desde Agenda -->
<div class="modal fade" id="modalAgregarAlumnoAgenda" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Agregar Alumno al Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarAlumnoAgenda">
                    <input type="hidden" id="eventoIdAgenda">
                    <div class="mb-3">
                        <label for="emailAgenda" class="form-label">Correo Electrónico *</label>
                        <input type="email" class="form-control" id="emailAgenda" name="email" required>
                        <div class="form-text">Ingrese el correo del alumno para buscar si ya está registrado</div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm mb-3" onclick="buscarAlumnoAgenda()">
                        <i class="fas fa-search"></i> Buscar Alumno
                    </button>
                    
                    <div id="camposAdicionalesAgenda" style="display: none;">
                        <div class="mb-3">
                            <label for="nombreAgenda" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nombreAgenda" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefonoAgenda" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="telefonoAgenda" name="telefono">
                        </div>
                    </div>
                    
                    <div id="infoAlumnoAgenda" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle"></i> 
                        <span id="mensajeAlumnoAgenda"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarAgregarAgenda" disabled>Agregar Alumno</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Asignar Instructor -->
<div class="modal fade" id="modalAsignarInstructor" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Agregar Instructor al Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Evento: <strong id="nombreEventoAsignar"></strong></p>
                <div class="mb-3">
                    <label for="instructorSelect" class="form-label">Seleccionar Instructor</label>
                    <select class="form-select" id="instructorSelect" required>
                        <option value="">Seleccione un instructor</option>
                        {% for instructor in instructores %}
                            <option value="{{ instructor._id }}|{{ instructor.email }}|{{ instructor.nombre }}">
                                {{ instructor.nombre }} ({{ instructor.email }})
                            </option>
                        {% else %}
                            <option value="" disabled>No hay instructores disponibles</option>
                        {% endfor %}
                    </select>
                    {% if instructores|length == 0 %}
                    <div class="alert alert-warning mt-2">
                        <small>No hay instructores registrados en el sistema.</small>
                    </div>
                    {% endif %}
                </div>
                <input type="hidden" id="eventoIdAsignar">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarAsignar" 
                        {% if instructores|length == 0 %}disabled{% endif %}>
                    Asignar Instructor
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Cerrar Evento -->
<div class="modal fade" id="modalCerrarEvento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">Cerrar Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea cerrar el evento: <strong id="nombreEventoCerrar"></strong>?</p>
                <div class="alert alert-warning">
                    <small>
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Nota:</strong> Una vez cerrado el evento, no se podrán agregar más alumnos.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnConfirmarCerrar">Sí, Cerrar Evento</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// =============================================
// FUNCIONES PARA AGREGAR ALUMNO DESDE AGENDA
// =============================================

// Variables globales
let eventoIdActual = null;
let eventoNombreActual = null;

// Función para abrir el modal de agregar alumno
function agregarAlumnoEvento(eventoId, eventoNombre) {
    console.log("Agregando alumno al evento:", eventoId, eventoNombre);
    eventoIdActual = eventoId;
    eventoNombreActual = eventoNombre;
    
    // Limpiar el formulario
    document.getElementById('formAgregarAlumnoAgenda').reset();
    document.getElementById('camposAdicionalesAgenda').style.display = 'none';
    document.getElementById('infoAlumnoAgenda').style.display = 'none';
    document.getElementById('btnConfirmarAgregarAgenda').disabled = true;
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalAgregarAlumnoAgenda'));
    modal.show();
}

// Función para buscar alumno por email
function buscarAlumnoAgenda() {
    const email = document.getElementById('emailAgenda').value;
    if (!email) {
        alert('Por favor ingrese un correo electrónico');
        return;
    }

    // Mostrar loading
    const btnBuscar = event.target;
    const originalText = btnBuscar.innerHTML;
    btnBuscar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
    btnBuscar.disabled = true;

    fetch(`/admin/buscar_alumno?email=${encodeURIComponent(email)}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                // Alumno existe
                document.getElementById('nombreAgenda').value = data.alumno.nombre;
                document.getElementById('telefonoAgenda').value = data.alumno.telefono || '';
                document.getElementById('camposAdicionalesAgenda').style.display = 'block';
                
                document.getElementById('mensajeAlumnoAgenda').textContent = 
                    `Alumno encontrado: ${data.alumno.nombre}. Puede editar los datos si es necesario.`;
                document.getElementById('infoAlumnoAgenda').className = 'alert alert-info';
                document.getElementById('infoAlumnoAgenda').style.display = 'block';
                
                document.getElementById('btnConfirmarAgregarAgenda').disabled = false;
            } else {
                // Alumno no existe
                document.getElementById('nombreAgenda').value = '';
                document.getElementById('telefonoAgenda').value = '';
                document.getElementById('camposAdicionalesAgenda').style.display = 'block';
                
                document.getElementById('mensajeAlumnoAgenda').textContent = 
                    'Alumno no encontrado. Por favor complete los datos requeridos.';
                document.getElementById('infoAlumnoAgenda').className = 'alert alert-warning';
                document.getElementById('infoAlumnoAgenda').style.display = 'block';
                
                document.getElementById('btnConfirmarAgregarAgenda').disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al buscar alumno');
        })
        .finally(() => {
            // Restaurar botón
            btnBuscar.innerHTML = originalText;
            btnBuscar.disabled = false;
        });
}

// Configurar evento para el botón de confirmar en agenda
document.getElementById('btnConfirmarAgregarAgenda').addEventListener('click', function() {
    const email = document.getElementById('emailAgenda').value;
    const nombre = document.getElementById('nombreAgenda').value;
    const telefono = document.getElementById('telefonoAgenda').value;

    if (!email || !nombre) {
        alert('El correo electrónico y nombre son requeridos');
        return;
    }

    // Mostrar loading
    const btnConfirmar = this;
    const originalText = btnConfirmar.innerHTML;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agregando...';
    btnConfirmar.disabled = true;

    const formData = new FormData();
    formData.append('email', email);
    formData.append('nombre', nombre);
    formData.append('telefono', telefono);

    fetch(`/admin/evento/${eventoIdActual}/agregar_alumno`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Cerrar modal y recargar página
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalAgregarAlumnoAgenda'));
            modal.hide();
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al agregar alumno');
    })
    .finally(() => {
        btnConfirmar.innerHTML = originalText;
        btnConfirmar.disabled = false;
    });
});

// =============================================
// FUNCIONES EXISTENTES DE LA AGENDA
// =============================================

// Efecto hover para las tarjetas de eventos
document.addEventListener('DOMContentLoaded', function() {
    const eventCards = document.querySelectorAll('.event-card');
    eventCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
    });

    // Asignar eventos a los botones de agregar alumno
    document.querySelectorAll('.agregar-alumno-agenda').forEach(button => {
        button.addEventListener('click', function() {
            const eventoId = this.getAttribute('data-evento-id');
            const eventoNombre = this.getAttribute('data-evento-nombre');
            agregarAlumnoEvento(eventoId, eventoNombre);
        });
    });
});

let eventoIdACerrar = null;

function mostrarModalCerrarEvento(eventoId, eventoNombre) {
    eventoIdACerrar = eventoId;
    document.getElementById('nombreEventoCerrar').textContent = eventoNombre;
    
    const modal = new bootstrap.Modal(document.getElementById('modalCerrarEvento'));
    modal.show();
}

// ✅ CORREGIDO: Función para cerrar evento con la ruta correcta
function confirmarCerrarEvento() {
    if (eventoIdACerrar) {
        fetch(`/eventos/evento/${eventoIdACerrar}/cerrar`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Evento cerrado exitosamente');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cerrar el evento');
        });
    }
}

function editarEvento(eventoId) {
    alert('Funcionalidad para editar evento ' + eventoId + ' - Pendiente de implementar');
}

// Asignar evento al botón de confirmar cierre
document.getElementById('btnConfirmarCerrar').addEventListener('click', confirmarCerrarEvento);

// =============================================
// FUNCIONES PARA ASIGNAR INSTRUCTOR
// =============================================

document.addEventListener('DOMContentLoaded', function() {
    // Modal para asignar instructor
    const modalAsignarInstructor = new bootstrap.Modal(document.getElementById('modalAsignarInstructor'));
    let eventoIdAsignar = null;

    // Abrir modal para asignar instructor
    document.querySelectorAll('.asignar-instructor').forEach(button => {
        button.addEventListener('click', function() {
            eventoIdAsignar = this.getAttribute('data-evento-id');
            const eventoNombre = this.getAttribute('data-evento-nombre');
            
            console.log("Abriendo modal para evento:", eventoIdAsignar, eventoNombre);
            
            document.getElementById('nombreEventoAsignar').textContent = eventoNombre;
            document.getElementById('eventoIdAsignar').value = eventoIdAsignar;
            
            // Resetear el select
            document.getElementById('instructorSelect').value = '';
            
            modalAsignarInstructor.show();
        });
    });

    // Confirmar asignación de instructor
    document.getElementById('btnConfirmarAsignar').addEventListener('click', function() {
        const instructorSelect = document.getElementById('instructorSelect');
        const instructorValue = instructorSelect.value;
        
        if (!instructorValue) {
            alert('Por favor seleccione un instructor');
            return;
        }

        // Separar los valores: id|email|nombre
        const [instructorId, instructorEmail, instructorNombre] = instructorValue.split('|');

        console.log("Enviando datos:", {
            evento_id: eventoIdAsignar,
            instructor_email: instructorEmail,
            instructor_nombre: instructorNombre
        });

        // Enviar datos al servidor
        fetch('/admin/asignar_instructor_evento', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                evento_id: eventoIdAsignar,
                instructor_email: instructorEmail,
                instructor_nombre: instructorNombre
            })
        })
        .then(response => {
            console.log("Respuesta recibida, status:", response.status);
            if (!response.ok) {
                // Si la respuesta no es OK, intentar leer el texto para debug
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("Datos parseados:", data);
            if (data.success) {
                alert(data.message || 'Instructor asignado exitosamente');
                modalAsignarInstructor.hide();
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error completo:', error);
            alert('Error al asignar instructor: ' + error.message);
        });
    });
});

// =============================================
// FUNCIONES AUXILIARES PARA ESCALAS
// =============================================

// Función para convertir escala de cuestionarios (0-10) a texto
function convertirEscalaCuestionario(puntaje) {
    if (puntaje >= 9) return "Excelente";
    if (puntaje >= 8) return "Muy Bien";
    if (puntaje >= 7) return "Bien";
    if (puntaje >= 6) return "Regular";
    return "Necesita mejorar";
}

// Función para convertir escala de evaluaciones (0-6) a texto
function convertirEscalaEvaluacion(puntaje) {
    if (puntaje >= 5.5) return "Excelente";
    if (puntaje >= 4.5) return "Muy Bien";
    if (puntaje >= 3.5) return "Bien";
    if (puntaje >= 2.5) return "Regular";
    return "Necesita mejorar";
}
</script>

<style>
/* Estilos embebidos para las estadísticas */
.event-stats {
    background-color: #f8f9fa;
    border-radius: 6px;
    padding: 12px;
}

.stat-item {
    padding: 4px 0;
}

.stat-item small {
    font-size: 0.8rem;
}

.event-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

/* Responsive para móviles */
@media (max-width: 768px) {
    .event-actions {
        flex-direction: column;
    }
    
    .event-actions .btn {
        margin-bottom: 5px;
    }
}
</style>
{% endblock %}