{% extends "base.html" %}

{% block title %}Alumnos del Evento - Administrador{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4 text-gray-800">Alumnos del Evento: {{ evento.curso_nombre }}</h1>
        </div>
    </div>

    <!-- Informaci√≥n del Evento -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Informaci√≥n del Evento</h5>
                    <p><strong>Curso:</strong> {{ evento.curso_nombre }}</p>
                    <p><strong>Fecha:</strong> {{ evento.fecha_evento.strftime('%d/%m/%Y') if evento.fecha_evento else 'No especificada' }}</p>
                    <p><strong>Instructor:</strong> {{ evento.instructor_nombre or 'No asignado' }}</p>
                    <p><strong>Total de alumnos:</strong> {{ evento.alumnos_asignados|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Estad√≠sticas</h5>
                    <p><strong>Cuestionarios contestados:</strong> {{ evento.cuestionarios_contestados or 0 }}/{{ evento.alumnos_asignados|length }}</p>
                    <p><strong>Evaluaciones registradas:</strong> {{ evento.evaluaciones_contestadas or 0 }}/{{ evento.alumnos_asignados|length }}</p>
                    <!-- ‚úÖ A√ëADIDO: Porcentajes de participaci√≥n -->
                    {% set total_alumnos = evento.alumnos_asignados|length %}
                    {% set porcentaje_cuestionarios = ((evento.cuestionarios_contestados or 0) / total_alumnos * 100) if total_alumnos > 0 else 0 %}
                    {% set porcentaje_evaluaciones = ((evento.evaluaciones_contestadas or 0) / total_alumnos * 100) if total_alumnos > 0 else 0 %}
                    <div class="mt-3">
                        <small class="text-muted">Participaci√≥n en Cuestionarios:</small>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ porcentaje_cuestionarios }}%"
                                 aria-valuenow="{{ porcentaje_cuestionarios }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <small class="text-muted">Participaci√≥n en Evaluaciones:</small>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" role="progressbar" 
                                 style="width: {{ porcentaje_evaluaciones }}%"
                                 aria-valuenow="{{ porcentaje_evaluaciones }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficas de Calificaciones - VERSI√ìN CORREGIDA -->
    <div class="row mb-4">
        <!-- Gr√°fica 1: Calificaciones de Cuestionarios (Donut) -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">Calificaciones de Cuestionarios</h6>
                </div>
                <div class="card-body">
                    {% if evento.cuestionarios_contestados > 0 %}
                        <div class="grafica-container" style="cursor: pointer;" onclick="ampliarGrafica('cuestionarios', 'Calificaciones de Cuestionarios')">
                            <canvas id="graficaCuestionarios"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <p><strong>Promedio: {{ "%.1f"|format(evento.promedio_cuestionarios) }}%</strong></p>
                            <small class="text-muted">
                                <span class="badge bg-danger">0-50%</span>
                                <span class="badge bg-warning">51-70%</span>
                                <span class="badge bg-info">71-85%</span>
                                <span class="badge bg-success">86-100%</span>
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2" 
                                onclick="ampliarGrafica('cuestionarios', 
                                                        'Calificaciones de Cuestionarios', 
                                                        {{ evento.promedio_cuestionarios|default(0) }}, 
                                                        {{ evento.promedio_evaluaciones|default(0) }},
                                                        {{ evento.cuestionarios_contestados|default(0) }},
                                                        {{ evento.evaluaciones_contestadas|default(0) }})">
                            <i class="fas fa-expand"></i> Ampliar Gr√°fica
                        </button>
                    {% else %}
                        <div class="alert alert-info text-center py-4">
                            <i class="fas fa-chart-bar fa-2x mb-2"></i>
                            <p>No hay cuestionarios registrados</p>
                        </div>

                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Gr√°fica 2: Promedios de Evaluaciones (L√≠nea) -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="m-0 font-weight-bold">Promedios de Evaluaciones</h6>
                </div>
                <div class="card-body">
                    {% if evento.evaluaciones_contestadas > 0 %}
                        <div class="grafica-container" style="cursor: pointer;" onclick="ampliarGrafica('evaluaciones', 'Promedios de Evaluaciones')">
                            <canvas id="graficaEvaluaciones" width="400" height="200"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <p><strong>Promedio: {{ "%.1f"|format(evento.promedio_evaluaciones) }}/6</strong></p>
                            <small class="text-muted">Escala de evaluaci√≥n: 1-6 puntos</small>
                            <div class="mt-2">
                                <small class="text-muted">
                                    Evaluaciones registradas: {{ evento.evaluaciones_contestadas }}/{{ evento.total_alumnos }}
                                </small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2" 
                                onclick="ampliarGrafica('evaluaciones', 
                                                        'Promedios de Evaluaciones', 
                                                        {{ evento.promedio_cuestionarios|default(0) }}, 
                                                        {{ evento.promedio_evaluaciones|default(0) }},
                                                        {{ evento.cuestionarios_contestados|default(0) }},
                                                        {{ evento.evaluaciones_contestadas|default(0) }})">
                                <i class="fas fa-expand"></i> Ampliar Gr√°fica
                        </button>
                    {% else %}
                        <div class="alert alert-info text-center py-4">
                            <i class="fas fa-star fa-2x mb-3"></i>
                            <h5>SIN DATOS</h5>
                           <p>No hay evaluaciones registradas</p>
                            <small class="text-muted">
                                Evaluaciones contestadas: {{ evento.evaluaciones_contestadas }}/{{ evento.total_alumnos }}
                            </small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- ‚úÖ NUEVA GR√ÅFICA: Calificaci√≥n por Alumno (Barras) -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h6 class="m-0 font-weight-bold">Calificaci√≥n por Alumno</h6>
                </div>
                <div class="card-body">
                    {% if alumnos %}
                        <div class="grafica-container" style="cursor: pointer;" onclick="ampliarGrafica('alumnos', 'Calificaci√≥n por Alumno')">
                            <canvas id="graficaAlumnos" width="400" height="200"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <span class="badge bg-danger">0-50%</span>
                                <span class="badge bg-warning">51-70%</span>
                                <span class="badge bg-info">71-80%</span>
                                <span class="badge bg-success">81-100%</span>
                            </small>
                            <div class="mt-2">
                                <small class="text-muted">
                                    Alumnos con cuestionario: {{ evento.cuestionarios_contestados }}/{{ evento.total_alumnos }}
                                </small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2" 
                                onclick="ampliarGrafica('alumnos', 
                                                        'Calificaci√≥n por Alumno', 
                                                        {{ evento.promedio_cuestionarios|default(0) }}, 
                                                        {{ evento.promedio_evaluaciones|default(0) }},
                                                        {{ evento.cuestionarios_contestados|default(0) }},
                                                        {{ evento.evaluaciones_contestadas|default(0) }})">
                            <i class="fas fa-expand"></i> Ampliar Gr√°fica
                        </button>
                    {% else %}
                        <div class="alert alert-info text-center py-4">
                            <i class="fas fa-users fa-2x mb-3"></i>
                            <h5>SIN DATOS</h5>
                            <p>No hay alumnos inscritos</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Alumnos -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Lista de Alumnos Inscritos</h6>
                    <div>
                        <button class="btn btn-primary btn-sm" onclick="agregarAlumno()">
                            <i class="fas fa-plus"></i> Agregar Alumno
                        </button>
                        <!-- ‚úÖ A√ëADIDO: Bot√≥n para recargar datos -->
                        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if alumnos %}
                    <div class="table-responsive">
                        <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Tel√©fono</th>
                                    <th>Fecha de Inscripci√≥n</th>
                                    <th>Calificaci√≥n Cuestionario</th>
                                    <th>Promedio Evaluaci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alumno in alumnos %}
                                <tr>
                                    <td>{{ alumno.nombre }}</td>
                                    <td>{{ alumno.email }}</td>
                                    <td>{{ alumno.telefono or 'No especificado' }}</td>
                                    <td>{{ alumno.fecha_inscripcion.strftime('%d/%m/%Y %H:%M') if alumno.fecha_inscripcion else 'No registrada' }}</td>
                                    <td>
                                        {% if alumno.tiene_cuestionario and alumno.cuestionario %}
                                            <span class="badge bg-{{ 'success' if alumno.cuestionario.calificacion >= 8 else 'warning' if alumno.cuestionario.calificacion >= 6 else 'danger' }}">
                                                {{ alumno.cuestionario.calificacion }}%
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">No contestado</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if alumno.tiene_evaluacion and alumno.evaluacion %}
                                            <span class="badge bg-{{ 'success' if alumno.evaluacion.puntuacion_promedio >= 4.5 else 'warning' if alumno.evaluacion.puntuacion_promedio >= 3 else 'danger' }}">
                                                {{ "%.1f"|format(alumno.evaluacion.puntuacion_promedio) }}/6
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">No evaluado</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-warning" onclick="editarAlumno('{{ alumno.email }}')" title="Editar alumno">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger" onclick="eliminarAlumno('{{ evento._id }}', '{{ alumno.email }}')" title="Eliminar del evento">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% if alumno.tiene_cuestionario or alumno.tiene_evaluacion %}
                                            <button class="btn btn-info" onclick="verDetallesAlumno('{{ alumno.email }}')" title="Ver estad√≠sticas">
                                                <i class="fas fa-chart-bar"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay alumnos inscritos en este evento.</p>
                        <button class="btn btn-primary" onclick="agregarAlumno()">
                            <i class="fas fa-plus"></i> Agregar Primer Alumno
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <!-- BOT√ìN MODIFICADO PARA VOLVER ATR√ÅS -->
                <button type="button" class="btn btn-secondary" onclick="volverAtras()">
                    <i class="fas fa-arrow-left"></i> Volver Atr√°s
                </button>
            
                <button class="btn btn-info" onclick="generarReporte()">
                    <i class="fas fa-download"></i> Generar Reporte
                </button>
            
                {% if evento.estatus == 'abierto' %}
                    <button class="btn btn-success" onclick="cerrarEvento()">
                        <i class="fas fa-lock"></i> Cerrar Evento
                    </button>
                {% else %}
                    <button class="btn btn-warning" onclick="reabrirEvento()">
                        <i class="fas fa-lock-open"></i> Reabrir Evento
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Los modales se mantienen igual -->
<!-- Modal para agregar alumno -->
<div class="modal fade" id="modalAgregarAlumno" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Agregar Alumno al Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAgregarAlumno">
                    <div class="mb-3">
                        <label for="email" class="form-label">Correo Electr√≥nico *</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <button type="button" class="btn btn-outline-secondary mb-3" onclick="buscarAlumno()">
                        <i class="fas fa-search"></i> Buscar Alumno
                    </button>
                    
                    <div id="camposAdicionales" style="display: none;">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefono" class="form-label">Tel√©fono</label>
                            <input type="text" class="form-control" id="telefono" name="telefono">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarAgregar" onclick="confirmarAgregar()" disabled>Agregar Alumno</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar alumno -->
<div class="modal fade" id="modalEditarAlumno" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title">Editar Alumno</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarAlumno">
                    <input type="hidden" id="email_original" name="email_original">
                    <div class="mb-3">
                        <label for="nuevo_email" class="form-label">Correo Electr√≥nico *</label>
                        <input type="email" class="form-control" id="nuevo_email" name="nuevo_email" required>
                    </div>
                    <div class="mb-3">
                        <label for="nuevo_nombre" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="nuevo_nombre" name="nuevo_nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="nuevo_telefono" class="form-label">Tel√©fono</label>
                        <input type="text" class="form-control" id="nuevo_telefono" name="nuevo_telefono">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnConfirmarEditar" onclick="confirmarEditar()">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles de alumno -->
<div class="modal fade" id="modalDetallesAlumno" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Estad√≠sticas Detalladas del Alumno</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detallesAlumnoContent">
                    <!-- Contenido cargado din√°micamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ NUEVO MODAL: Para gr√°ficas ampliadas -->
<div class="modal fade" id="modalGraficaAmpliada" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tituloGraficaAmpliada">Gr√°fica Ampliada</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="leyendaGraficaAmpliada" class="mb-3"></div>
                <!-- Aseg√∫rate de que el canvas tenga dimensiones m√≠nimas -->
                <div style="position: relative; height: 70vh; width: 100%;">
                    <canvas id="graficaAmpliadaCanvas"></canvas>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="descargarGrafica()">
                    <i class="fas fa-download"></i> Descargar
                </button>
            </div>
        </div>
    </div>
</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cerrar
                </button>
                <button type="button" class="btn btn-info" onclick="descargarGrafica()">
                    <i class="fas fa-download"></i> Descargar Imagen
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Cargar Chart.js localmente para evitar Tracking Prevention -->
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

<script>
// VERSI√ìN: 9.0 - Corregida sin errores de sintaxis
console.log("=== INICIANDO SISTEMA DE GR√ÅFICAS ===");

// ‚úÖ VERIFICAR SI CHART.JS EST√Å CARGADO
if (typeof Chart === 'undefined') {
    console.error("‚ùå Chart.js NO est√° cargado. Verifica la ruta del archivo.");
} else {
    console.log("‚úÖ Chart.js cargado, versi√≥n:", Chart.version);
}

// ‚úÖ VARIABLES GLOBALES
let chartInstances = {
    cuestionarios: null,
    evaluaciones: null,
    alumnos: null
};

// ‚úÖ INICIALIZACI√ìN CUANDO EL DOM EST√â LISTO
document.addEventListener('DOMContentLoaded', function() {
    console.log("üìÑ DOM cargado completamente");
    
    // Forzar dimensiones de los canvas
    const canvasIds = ['graficaCuestionarios', 'graficaEvaluaciones', 'graficaAlumnos'];
    canvasIds.forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
            canvas.width = 400;
            canvas.height = 250;
            console.log(`‚úÖ Canvas ${id} dimensionado: ${canvas.width}x${canvas.height}`);
        } else {
            console.warn(`‚ö†Ô∏è Canvas ${id} no encontrado`);
        }
    });
    
    // Inicializar gr√°ficas despu√©s de un peque√±o retraso
    setTimeout(initCharts, 500);
});

// ‚úÖ FUNCI√ìN PRINCIPAL DE INICIALIZACI√ìN
function initCharts() {
    console.log("üîÑ Inicializando gr√°ficas...");
    
    if (typeof Chart === 'undefined') {
        console.error("‚ùå ERROR: Chart.js no est√° disponible");
        showErrorMessages();
        return;
    }
    
    // Intentar cargar datos del servidor
    loadChartData();
}

// ‚úÖ CARGAR DATOS DE GR√ÅFICAS
function loadChartData() {
    console.log("üì° Solicitando datos de gr√°ficas...");
    
    // Usar la ruta correcta para la API
    const eventoId = '{{ evento._id }}';
    const apiUrl = `/evento/${eventoId}/estadisticas`;
    
    console.log("üîó URL de API:", apiUrl);
    
    // Primero intentar con datos de prueba para verificar que Chart.js funciona
    testChartJS();
    
    // Luego intentar cargar datos reales
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("üìä Datos recibidos:", data);
            if (data.success && data.datos) {
                createCharts(data.datos);
            } else {
                throw new Error(data.message || "Datos inv√°lidos");
            }
        })
        .catch(error => {
            console.error("‚ùå Error cargando datos:", error);
            // Usar datos de prueba como fallback
            useTestData();
        });
}

// ‚úÖ TESTEAR CHART.JS CON DATOS SIMPLES
function testChartJS() {
    try {
        const testCanvas = document.createElement('canvas');
        testCanvas.width = 100;
        testCanvas.height = 100;
        document.body.appendChild(testCanvas);
        
        const testChart = new Chart(testCanvas, {
            type: 'bar',
            data: {
                labels: ['Test'],
                datasets: [{
                    label: 'Test',
                    data: [1],
                    backgroundColor: 'red'
                }]
            }
        });
        
        testChart.destroy();
        testCanvas.remove();
        console.log("‚úÖ Test de Chart.js: EXITOSO");
    } catch (error) {
        console.error("‚ùå Test de Chart.js: FALLIDO", error);
    }
}

// ‚úÖ DATOS DE PRUEBA PARA VERIFICAR GR√ÅFICAS
function useTestData() {
    console.log("üîÑ Usando datos de prueba...");
    
    const testData = {
        cuestionarios: {
            labels: ['0-50%', '51-70%', '71-85%', '86-100%'],
            datasets: [{
                data: [0, 2, 0, 0],
                backgroundColor: ['#dc3545', '#ffc107', '#0dcaf0', '#198754']
            }]
        },
        evaluaciones: {
            labels: ['Alumno 1', 'Alumno 2'],
            datasets: [{
                label: 'Evaluaci√≥n',
                data: [5.5, 5.9],
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                borderWidth: 2
            }]
        },
        alumnos: {
            labels: ['Alumno 1', 'Alumno 2'],
            datasets: [{
                label: 'Calificaci√≥n',
                data: [61, 69],
                backgroundColor: ['#0d6efd', '#6f42c1']
            }]
        }
    };
    
    createCharts(testData);
}

// ‚úÖ CREAR TODAS LAS GR√ÅFICAS
function createCharts(chartData) {
    console.log("üé® Creando gr√°ficas...");
    
    // 1. Gr√°fica de cuestionarios
    if (chartData.cuestionarios) {
        createDonutChart('graficaCuestionarios', chartData.cuestionarios, 'Calificaciones de Cuestionarios');
    } else {
        showNoData('graficaCuestionarios', 'cuestionarios');
    }
    
    // 2. Gr√°fica de evaluaciones
    if (chartData.evaluaciones) {
        createLineChart('graficaEvaluaciones', chartData.evaluaciones, 'Promedios de Evaluaciones');
    } else {
        showNoData('graficaEvaluaciones', 'evaluaciones');
    }
    
    // 3. Gr√°fica de alumnos
    if (chartData.alumnos) {
        createBarChart('graficaAlumnos', chartData.alumnos, 'Calificaci√≥n por Alumno');
    } else {
        showNoData('graficaAlumnos', 'alumnos');
    }
}

// ‚úÖ CREAR GR√ÅFICA DE DONUT (CUESTIONARIOS)
function createDonutChart(canvasId, data, title) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    // Destruir gr√°fica anterior
    if (chartInstances.cuestionarios) {
        chartInstances.cuestionarios.destroy();
    }
    
    const ctx = canvas.getContext('2d');
    chartInstances.cuestionarios = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} alumno(s) (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    console.log(`‚úÖ Gr√°fica de donut creada: ${title}`);
}

// ‚úÖ CREAR GR√ÅFICA DE L√çNEA (EVALUACIONES)
function createLineChart(canvasId, data, title) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    if (chartInstances.evaluaciones) {
        chartInstances.evaluaciones.destroy();
    }
    
    const ctx = canvas.getContext('2d');
    chartInstances.evaluaciones = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 6,
                    ticks: {
                        stepSize: 1
                    },
                    title: {
                        display: true,
                        text: 'Calificaci√≥n (1-6)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    console.log(`‚úÖ Gr√°fica de l√≠nea creada: ${title}`);
}

// ‚úÖ CREAR GR√ÅFICA DE BARRAS (ALUMNOS)
function createBarChart(canvasId, data, title) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    if (chartInstances.alumnos) {
        chartInstances.alumnos.destroy();
    }
    
    const ctx = canvas.getContext('2d');
    chartInstances.alumnos = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 10
                    },
                    title: {
                        display: true,
                        text: 'Calificaci√≥n (%)'
                    }
                },
                x: {
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    console.log(`‚úÖ Gr√°fica de barras creada: ${title}`);
}

// ‚úÖ MOSTRAR MENSAJE "SIN DATOS"
function showNoData(canvasId, chartType) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Limpiar canvas
    ctx.clearRect(0, 0, width, height);
    
    // Dibujar fondo
    ctx.fillStyle = '#f8f9fa';
    ctx.fillRect(0, 0, width, height);
    
    // Dibujar borde
    ctx.strokeStyle = '#dee2e6';
    ctx.lineWidth = 1;
    ctx.strokeRect(0, 0, width, height);
    
    // Dibujar texto
    ctx.fillStyle = '#6c757d';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // Icono
    ctx.font = 'bold 30px Arial';
    ctx.fillText('üìä', width / 2, height / 2 - 20);
    
    // Mensaje
    ctx.font = 'bold 14px Arial';
    ctx.fillText('SIN DATOS', width / 2, height / 2 + 10);
    
    // Subt√≠tulo
    ctx.font = '12px Arial';
    ctx.fillText(`No hay ${chartType} disponibles`, width / 2, height / 2 + 30);
    
    console.log(`‚ö†Ô∏è Mostrando "Sin datos" para ${chartType}`);
}

// ‚úÖ MOSTRAR MENSAJES DE ERROR
function showErrorMessages() {
    const containers = [
        document.getElementById('graficaCuestionarios')?.parentElement,
        document.getElementById('graficaEvaluaciones')?.parentElement,
        document.getElementById('graficaAlumnos')?.parentElement
    ];
    
    containers.forEach(container => {
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger text-center p-3">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h6>Error al cargar gr√°ficas</h6>
                    <small>Chart.js no se pudo cargar correctamente</small>
                </div>
            `;
        }
    });
}

// ‚úÖ FUNCI√ìN PARA VERIFICAR SI CHART.JS EST√Å CARGADO
function verificarChartJS() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js no est√° cargado');
        return false;
    }
    console.log('Chart.js cargado correctamente, versi√≥n:', Chart.version);
    return true;
}

// ‚úÖ VARIABLES GLOBALES PARA ALMACENAR INSTANCIAS DE GR√ÅFICAS
let graficasInstancias = {
    cuestionarios: null,
    evaluaciones: null,
    alumnos: null,
    ampliada: null
};

// ‚úÖ CONFIGURACIONES DE GR√ÅFICAS
let configGraficas = {
    cuestionarios: null,
    evaluaciones: null,
    alumnos: null
};

// Inicializar gr√°ficas cuando el documento est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM completamente cargado');
    
    // Verificar que los canvas existan
    const canvasCues = document.getElementById('graficaCuestionarios');
    const canvasEval = document.getElementById('graficaEvaluaciones');
    const canvasAlumnos = document.getElementById('graficaAlumnos');
    
    if (!canvasCues || !canvasEval || !canvasAlumnos) {
        console.error('No se encontraron todos los elementos canvas');
        return;
    }
    
    console.log('Canvas encontrados, inicializando gr√°ficas...');
    
    if (typeof Chart !== 'undefined') {
        inicializarGraficas();
    } else {
        console.error('Chart.js no se carg√≥ correctamente');
        mostrarMensajesErrorGraficas();
    }
});

function inicializarGraficas() {
    if (!verificarChartJS()) {
        console.error('No se puede inicializar gr√°ficas: Chart.js no disponible');
        mostrarMensajesErrorGraficas();
        return;
    }
    
    try {
        console.log('Chart.js disponible, inicializando gr√°ficas...');
        obtenerDatosGraficasReales();
    } catch (error) {
        console.error('Error cr√≠tico al inicializar gr√°ficas:', error);
        mostrarMensajesErrorGraficas();
    }
}

// ‚úÖ FUNCI√ìN PARA AMPLIAR GR√ÅFICA (igual que antes, pero simplificada)
function ampliarGrafica(tipo, titulo, promedioCuestionarios = 0, promedioEvaluaciones = 0, 
                       cuestionariosContestados = 0, evaluacionesContestadas = 0) {
    try {
        console.log(`Ampliando gr√°fica: ${tipo}, t√≠tulo: ${titulo}`);
        
        // Verificar si hay datos para la gr√°fica
        if (!configGraficas[tipo]) {
            alert('No hay datos disponibles para esta gr√°fica');
            return;
        }
        
        // Obtener configuraci√≥n de la gr√°fica seg√∫n el tipo
        let config = JSON.parse(JSON.stringify(configGraficas[tipo]));
        let leyendaHTML = '';
        
        // Configuraci√≥n com√∫n para todas las gr√°ficas ampliadas
        config.options = {
            ...config.options,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                ...(config.options.plugins || {}),
                legend: {
                    position: 'top',
                    labels: { font: { size: 14 } }
                }
            }
        };
        
        // Leyenda espec√≠fica por tipo
        switch(tipo) {
            case 'cuestionarios':
                leyendaHTML = `
                    <small class="text-muted">
                        <span class="badge bg-danger">0-50%</span>
                        <span class="badge bg-warning">51-70%</span>
                        <span class="badge bg-info">71-85%</span>
                        <span class="badge bg-success">86-100%</span>
                    </small>
                    <p class="mt-2"><strong>Promedio: ${promedioCuestionarios.toFixed(1)}%</strong></p>
                `;
                break;
                
            case 'evaluaciones':
                leyendaHTML = `
                    <p><strong>Escala de evaluaci√≥n: 1-6 puntos</strong></p>
                    <p><strong>Promedio: ${promedioEvaluaciones.toFixed(1)}/6</strong></p>
                `;
                break;
                
            case 'alumnos':
                leyendaHTML = `
                    <small class="text-muted">
                        <span class="badge bg-danger">0-50%</span>
                        <span class="badge bg-warning">51-70%</span>
                        <span class="badge bg-info">71-80%</span>
                        <span class="badge bg-success">81-100%</span>
                    </small>
                `;
                break;
        }
        
        // Actualizar t√≠tulo y leyenda del modal
        document.getElementById('tituloGraficaAmpliada').textContent = titulo;
        document.getElementById('leyendaGraficaAmpliada').innerHTML = leyendaHTML;
        
        // Configurar canvas
        const canvas = document.getElementById('graficaAmpliadaCanvas');
        if (!canvas) {
            console.error('Canvas no encontrado');
            alert('Error: Canvas no disponible');
            return;
        }
        
        canvas.width = 800;
        canvas.height = 600;
        
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Destruir gr√°fica anterior si existe
        if (graficasInstancias.ampliada) {
            graficasInstancias.ampliada.destroy();
        }
        
        // Crear nueva gr√°fica
        graficasInstancias.ampliada = new Chart(ctx, config);
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('modalGraficaAmpliada'));
        modal.show();
        
    } catch (error) {
        console.error('Error al ampliar gr√°fica:', error);
        alert('Error al mostrar la gr√°fica ampliada: ' + error.message);
    }
}

// ‚úÖ FUNCI√ìN PARA OBTENER DATOS DEL SERVIDOR
function obtenerDatosGraficasReales() {
    console.log('=== SOLICITANDO DATOS DE GR√ÅFICAS ===');
    const url = '{{ url_for("eventos.estadisticas_graficas", evento_id=evento._id) }}';
    console.log('URL de la API:', url);
    
    fetch(url)
    .then(response => {
        console.log('Estado de respuesta:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Datos recibidos del servidor:', data);
        
        if (data.success && data.datos) {
            console.log('Datos de gr√°ficas recibidos correctamente');
            console.log('Cuestionarios:', data.datos.cuestionarios);
            console.log('Evaluaciones:', data.datos.evaluaciones);
            console.log('Alumnos:', data.datos.alumnos);
            crearGraficasConDatosReales(data.datos);
        } else {
            console.warn('Respuesta sin datos v√°lidos:', data.message);
            mostrarGraficasSinDatos();
        }
    })
    .catch(error => {
        console.error('Error obteniendo datos reales:', error);
        mostrarGraficasSinDatos();
    });
}

// ‚úÖ FUNCI√ìN PARA CREAR GR√ÅFICAS CON DATOS DEL SERVIDOR
function crearGraficasConDatosReales(datos) {
    console.log('Creando gr√°ficas con datos del servidor...');
    
    // Gr√°fica de cuestionarios
    crearGraficaIndividual('graficaCuestionarios', datos.cuestionarios, 'doughnut', 'Cuestionarios');
    
    // Gr√°fica de evaluaciones
    crearGraficaIndividual('graficaEvaluaciones', datos.evaluaciones, 'line', 'Evaluaciones');
    
    // Gr√°fica de alumnos
    crearGraficaIndividual('graficaAlumnos', datos.alumnos, 'bar', 'Alumnos');
}

function crearGraficaIndividual(canvasId, datos, tipo, nombre) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    if (datos && datos.datasets) {
        configGraficas[nombre.toLowerCase()] = {
            type: tipo,
            data: datos,
            options: obtenerOpcionesGrafica(nombre)
        };
        
        // Destruir gr√°fica anterior si existe
        if (graficasInstancias[nombre.toLowerCase()]) {
            graficasInstancias[nombre.toLowerCase()].destroy();
        }
        
        // Crear nueva gr√°fica
        graficasInstancias[nombre.toLowerCase()] = new Chart(canvas, configGraficas[nombre.toLowerCase()]);
        console.log(`Gr√°fica de ${nombre} creada`);
    } else {
        mostrarMensajeSinDatos(canvasId, nombre);
    }
}

// ‚úÖ FUNCI√ìN PARA DESCARGAR LA GR√ÅFICA ACTUAL
function descargarGrafica() {
    try {
        const canvas = document.getElementById('graficaAmpliadaCanvas');
        if (!canvas) {
            alert('No hay gr√°fica para descargar');
            return;
        }
        
        // Crear un enlace de descarga
        const link = document.createElement('a');
        link.download = `grafica_${new Date().toISOString().slice(0, 10)}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    } catch (error) {
        console.error('Error al descargar gr√°fica:', error);
        alert('Error al descargar la gr√°fica');
    }
}



function obtenerDatosGraficasReales() {
    console.log('Solicitando datos de gr√°ficas al servidor...');
    const url = '{{ url_for("eventos.estadisticas_graficas", evento_id=evento._id) }}';
    console.log('URL:', url);
    // ... resto del c√≥digo
}
    
    fetch(url)
    .then(response => {
        console.log('Respuesta recibida, status:', response.status);
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Datos recibidos del servidor:', data);
        if (data.success && data.datos) {
            crearGraficasConDatosReales(data.datos);
        } else {
            throw new Error(data.message || 'No hay datos disponibles');
        }
    })
    .catch(error => {
        console.error('Error obteniendo datos reales:', error);
        mostrarGraficasSinDatos();
    });
}

function crearGraficasConDatosReales(datos) {
    console.log('=== CREANDO GR√ÅFICAS CON DATOS ===');
    
    // 1. Gr√°fica de cuestionarios
    if (datos.cuestionarios && datos.cuestionarios.datasets && datos.cuestionarios.datasets[0].data) {
        console.log('Creando gr√°fica de cuestionarios con datos:', datos.cuestionarios);
        crearGraficaCuestionarios(datos.cuestionarios);
    } else {
        console.warn('Datos de cuestionarios incompletos o vac√≠os');
        mostrarMensajeSinDatos('graficaCuestionarios', 'cuestionarios');
    }
    
    // 2. Gr√°fica de evaluaciones
    if (datos.evaluaciones && datos.evaluaciones.datasets && datos.evaluaciones.datasets[0].data) {
        console.log('Creando gr√°fica de evaluaciones con datos:', datos.evaluaciones);
        crearGraficaEvaluaciones(datos.evaluaciones);
    } else {
        console.warn('Datos de evaluaciones incompletos o vac√≠os');
        mostrarMensajeSinDatos('graficaEvaluaciones', 'evaluaciones');
    }
    
    // 3. Gr√°fica de alumnos
    if (datos.alumnos && datos.alumnos.datasets && datos.alumnos.datasets[0].data) {
        console.log('Creando gr√°fica de alumnos con datos:', datos.alumnos);
        crearGraficaAlumnos(datos.alumnos);
    } else {
        console.warn('Datos de alumnos incompletos o vac√≠os');
        mostrarMensajeSinDatos('graficaAlumnos', 'alumnos');
    }
}

function crearGraficasConDatosReales(datos) {
    console.log('=== CREANDO GR√ÅFICAS CON DATOS ===');
    
    // 1. Gr√°fica de cuestionarios
    if (datos.cuestionarios && datos.cuestionarios.datasets && datos.cuestionarios.datasets[0].data) {
        console.log('Creando gr√°fica de cuestionarios con datos:', datos.cuestionarios);
        crearGraficaCuestionarios(datos.cuestionarios);
    } else {
        console.warn('Datos de cuestionarios incompletos o vac√≠os');
        mostrarMensajeSinDatos('graficaCuestionarios', 'cuestionarios');
    }
    
    // 2. Gr√°fica de evaluaciones
    if (datos.evaluaciones && datos.evaluaciones.datasets && datos.evaluaciones.datasets[0].data) {
        console.log('Creando gr√°fica de evaluaciones con datos:', datos.evaluaciones);
        crearGraficaEvaluaciones(datos.evaluaciones);
    } else {
        console.warn('Datos de evaluaciones incompletos o vac√≠os');
        mostrarMensajeSinDatos('graficaEvaluaciones', 'evaluaciones');
    }
    
    // 3. Gr√°fica de alumnos
    if (datos.alumnos && datos.alumnos.datasets && datos.alumnos.datasets[0].data) {
        console.log('Creando gr√°fica de alumnos con datos:', datos.alumnos);
        crearGraficaAlumnos(datos.alumnos);
    } else {
        console.warn('Datos de alumnos incompletos o vac√≠os');
        mostrarMensajeSinDatos('graficaAlumnos', 'alumnos');
    }
}


function crearGraficaEvaluaciones(datos) {
    const ctx = document.getElementById('graficaEvaluaciones');
    if (!ctx) {
        console.error('Canvas de evaluaciones no encontrado');
        return;
    }
    
    if (graficasInstancias.evaluaciones) {
        graficasInstancias.evaluaciones.destroy();
    }
    
    graficasInstancias.evaluaciones = new Chart(ctx, {
        type: 'line',
        data: datos,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 6,
                    title: {
                        display: true,
                        text: 'Calificaci√≥n (1-6)'
                    }
                }
            }
        }
    });
}

function crearGraficaAlumnos(datos) {
    const ctx = document.getElementById('graficaAlumnos');
    if (!ctx) {
        console.error('Canvas de alumnos no encontrado');
        return;
    }
    
    if (graficasInstancias.alumnos) {
        graficasInstancias.alumnos.destroy();
    }
    
    graficasInstancias.alumnos = new Chart(ctx, {
        type: 'bar',
        data: datos,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Calificaci√≥n (%)'
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    }
                }
            }
        }
    });
}





function mostrarGraficasSinDatos() {
    console.log('Mostrando gr√°ficas sin datos...');
    mostrarMensajeSinDatos('graficaCuestionarios', 'Cuestionarios');
    mostrarMensajeSinDatos('graficaEvaluaciones', 'Evaluaciones');
}

function mostrarMensajesErrorGraficas() {
    // Mostrar mensaje de error en lugar de gr√°ficas
    const contenedorCues = document.getElementById('graficaCuestionarios')?.parentElement;
    const contenedorEval = document.getElementById('graficaEvaluaciones')?.parentElement;
    const contenedorAlumnos = document.getElementById('graficaAlumnos')?.parentElement;
    
    if (contenedorCues) {
        contenedorCues.innerHTML = '<div class="alert alert-warning text-center"><i class="fas fa-exclamation-triangle"></i> Error al cargar las gr√°ficas</div>';
    }
    if (contenedorEval) {
        contenedorEval.innerHTML = '<div class="alert alert-warning text-center"><i class="fas fa-exclamation-triangle"></i> Error al cargar las gr√°ficas</div>';
    }
    if (contenedorAlumnos) {
        contenedorAlumnos.innerHTML = '<div class="alert alert-warning text-center"><i class="fas fa-exclamation-triangle"></i> Error al cargar las gr√°ficas</div>';
    }
}

function mostrarMensajeSinDatos(canvasId, tipo) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas ${canvasId} no encontrado`);
        return;
    }
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        console.error(`No se pudo obtener el contexto 2D para ${canvasId}`);
        return;
    }
    
    // Limpiar canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Configurar estilo del texto
    ctx.fillStyle = '#6c757d';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // Dibujar texto centrado
    ctx.fillText('SIN DATOS', canvas.width / 2, canvas.height / 2);
    
    // Mensaje adicional m√°s peque√±o
    ctx.font = '12px Arial';
    ctx.fillText(`No hay ${tipo.toLowerCase()} registrados`, canvas.width / 2, canvas.height / 2 + 25);
}

function obtenerOpcionesGrafica(tipo) {
    const configComun = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    };

    if (tipo === 'Cuestionarios') {
        return {
            ...configComun,
            plugins: {
                ...configComun.plugins,
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return ` ${context.label}: ${context.raw} alumnos`;
                        }
                    }
                }
            }
        };
    } else {
        return {
            ...configComun,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 6,
                    title: {
                        display: true,
                        text: 'Calificaci√≥n (1-6)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Evaluaciones'
                    }
                }
            }
        };
    }
}


// ‚úÖ MEJORADO: Funci√≥n verDetallesAlumno
function verDetallesAlumno(email) {
    const originalBoton = event.target;
    const originalHTML = originalBoton.innerHTML;
    originalBoton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    originalBoton.disabled = true;

    fetch(`/admin/evento/{{ evento._id }}/detalles-alumno/${encodeURIComponent(email)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                mostrarDetallesAlumno(data.detalles);
            } else {
                throw new Error(data.message || 'Error al cargar detalles');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar detalles del alumno: ' + error.message);
        })
        .finally(() => {
            originalBoton.innerHTML = originalHTML;
            originalBoton.disabled = false;
        });
}

// ‚úÖ MEJORADO: Funci√≥n mostrarDetallesAlumno
function mostrarDetallesAlumno(detalles) {
    if (!detalles) {
        alert('No se recibieron datos del alumno');
        return;
    }

    const contenido = `
        <div class="row">
            <div class="col-md-6">
                <h6>Informaci√≥n del Alumno</h6>
                <p><strong>Nombre:</strong> ${detalles.nombre || 'No disponible'}</p>
                <p><strong>Email:</strong> ${detalles.email || 'No disponible'}</p>
                <p><strong>Tel√©fono:</strong> ${detalles.telefono || 'No especificado'}</p>
            </div>
            <div class="col-md-6">
                <h6>Rendimiento</h6>
                <p><strong>Calificaci√≥n Cuestionario:</strong> 
                    ${detalles.calificacion_cuestionario ? 
                        `<span class="badge bg-${detalles.calificacion_cuestionario >= 8 ? 'success' : detalles.calificacion_cuestionario >= 6 ? 'warning' : 'danger'}">
                            ${detalles.calificacion_cuestionario.toFixed(1)}/10
                        </span>` : 
                        '<span class="badge bg-secondary">No contestado</span>'}
                </p>
                <p><strong>Promedio Evaluaci√≥n:</strong> 
                    ${detalles.promedio_evaluacion ? 
                        `<span class="badge bg-${detalles.promedio_evaluacion >= 4.5 ? 'success' : detalles.promedio_evaluacion >= 3 ? 'warning' : 'danger'}">
                            ${detalles.promedio_evaluacion.toFixed(1)}/6
                        </span>` : 
                        '<span class="badge bg-secondary">No evaluado</span>'}
                </p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Desempe√±o por √Årea</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="graficaDetalleAlumno" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('detallesAlumnoContent').innerHTML = contenido;
    
    // Inicializar gr√°fica de detalle
    setTimeout(() => {
        try {
            if (detalles.calificacion_cuestionario || detalles.promedio_evaluacion) {
                inicializarGraficaDetalle(detalles);
            } else {
                mostrarMensajeSinDatos('graficaDetalleAlumno', 'Datos de desempe√±o');
            }
        } catch (error) {
            console.error('Error inicializando gr√°fica de detalle:', error);
            mostrarMensajeSinDatos('graficaDetalleAlumno', 'Datos de desempe√±o');
        }
    }, 100);
    
    const modal = new bootstrap.Modal(document.getElementById('modalDetallesAlumno'));
    modal.show();
}

// ‚úÖ MODIFICADO: Funci√≥n inicializarGraficaDetalle - solo si hay datos
function inicializarGraficaDetalle(detalles) {
    const ctx = document.getElementById('graficaDetalleAlumno').getContext('2d');
    
    const datosDetalle = {
        labels: ['Cuestionario', 'Evaluaci√≥n Taller', 'Evaluaci√≥n Instructor', 'Participaci√≥n'],
        datasets: [{
            label: 'Desempe√±o por √Årea',
            data: [
                detalles.calificacion_cuestionario || 0,
                detalles.promedio_taller || 0,
                detalles.promedio_instructor || 0,
                detalles.participacion || 0
            ],
            backgroundColor: [
                'rgba(54, 162, 235, 0.5)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(255, 159, 64, 0.5)',
                'rgba(153, 102, 255, 0.5)'
            ],
            borderColor: [
                'rgba(54, 162, 235, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(153, 102, 255, 1)'
            ],
            borderWidth: 2
        }]
    };
    
    new Chart(ctx, {
        type: 'bar',
        data: datosDetalle,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10,
                    title: {
                        display: true,
                        text: 'Calificaci√≥n'
                    }
                }
            }
        }
    });
}

// Las funciones restantes se mantienen igual...
function agregarAlumno() {
    console.log("Funci√≥n agregarAlumno ejecutada");
    document.getElementById('formAgregarAlumno').reset();
    document.getElementById('camposAdicionales').style.display = 'none';
    document.getElementById('btnConfirmarAgregar').disabled = true;
    
    const modal = new bootstrap.Modal(document.getElementById('modalAgregarAlumno'));
    modal.show();
}

function buscarAlumno() {
    const email = document.getElementById('email').value;
    if (!email) {
        alert('Por favor ingrese un correo electr√≥nico');
        return;
    }
    
    fetch(`/admin/buscar_alumno?email=${encodeURIComponent(email)}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                document.getElementById('nombre').value = data.alumno.nombre;
                document.getElementById('telefono').value = data.alumno.telefono || '';
                document.getElementById('camposAdicionales').style.display = 'block';
                document.getElementById('btnConfirmarAgregar').disabled = false;
            } else {
                document.getElementById('nombre').value = '';
                document.getElementById('telefono').value = '';
                document.getElementById('camposAdicionales').style.display = 'block';
                document.getElementById('btnConfirmarAgregar').disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al buscar alumno');
        });
}

function confirmarAgregar() {
    const email = document.getElementById('email').value;
    const nombre = document.getElementById('nombre').value;
    const telefono = document.getElementById('telefono').value;

    if (!email || !nombre) {
        alert('El correo electr√≥nico y nombre son requeridos');
        return;
    }

    const formData = new FormData();
    formData.append('email', email);
    formData.append('nombre', nombre);
    formData.append('telefono', telefono);

    fetch(`/admin/evento/{{ evento._id }}/agregar_alumno`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al agregar alumno');
    });
}

function editarAlumno(email) {
    console.log("Editando alumno:", email);
    
    const filas = document.querySelectorAll('#dataTable tbody tr');
    let alumnoData = null;
    
    for (let fila of filas) {
        const emailFila = fila.cells[1].textContent.trim();
        if (emailFila === email) {
            alumnoData = {
                nombre: fila.cells[0].textContent.trim(),
                email: emailFila,
                telefono: fila.cells[2].textContent.trim()
            };
            break;
        }
    }
    
    if (!alumnoData) {
        alert('No se pudieron cargar los datos del alumno');
        return;
    }
    
    document.getElementById('email_original').value = alumnoData.email;
    document.getElementById('nuevo_email').value = alumnoData.email;
    document.getElementById('nuevo_nombre').value = alumnoData.nombre;
    document.getElementById('nuevo_telefono').value = alumnoData.telefono === 'No especificado' ? '' : alumnoData.telefono;
    
    const modal = new bootstrap.Modal(document.getElementById('modalEditarAlumno'));
    modal.show();
}

function confirmarEditar() {
    const email_original = document.getElementById('email_original').value;
    const nuevo_email = document.getElementById('nuevo_email').value;
    const nuevo_nombre = document.getElementById('nuevo_nombre').value;
    const nuevo_telefono = document.getElementById('nuevo_telefono').value;

    if (!nuevo_email || !nuevo_nombre) {
        alert('El correo electr√≥nico y nombre son requeridos');
        return;
    }

    const formData = new FormData();
    formData.append('email_original', email_original);
    formData.append('nuevo_email', nuevo_email);
    formData.append('nuevo_nombre', nuevo_nombre);
    formData.append('nuevo_telefono', nuevo_telefono);

    fetch(`/admin/evento/{{ evento._id }}/editar-alumno`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al editar alumno');
    });
}

function eliminarAlumno(eventoId, email) {
    if (confirm('¬øEst√° seguro de que desea eliminar este alumno del evento?\n\nEsta acci√≥n no elimina al alumno del sistema, solo lo remueve de este evento.')) {
        // Opci√≥n 1: Usando fetch (m√°s moderna)
        fetch(`/admin/evento/${eventoId}/eliminar-alumno/${encodeURIComponent(email)}`, {
            method: 'GET'
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error al eliminar el alumno');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexi√≥n');
        });
    }
}

function generarReporte() {
    alert('Funcionalidad de reporte pendiente de implementar');
}

function cerrarEvento() {
    if (confirm('¬øEst√° seguro de que desea cerrar este evento? No se podr√°n agregar m√°s alumnos.')) {
        fetch(`/eventos/evento/{{ evento._id }}/cerrar`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Evento cerrado exitosamente');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cerrar el evento');
        });
    }
}

// ‚úÖ NUEVO: Funci√≥n para reabrir evento
function reabrirEvento() {
    if (confirm('¬øEst√° seguro de que desea reabrir este evento? Se podr√°n agregar m√°s alumnos.')) {
        fetch(`/eventos/evento/{{ evento._id }}/reabrir`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Evento reabierto exitosamente');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al reabrir el evento');
        });
    }
}

// ‚úÖ NUEVO: Funci√≥n para volver a la p√°gina anterior
function volverAtras() {
    // Si hay historial, volver atr√°s
    if (document.referrer) {
        window.history.back();
    } else {
        // Si no hay historial, ir a la agenda por defecto
        window.location.href = "{{ url_for('admin.agenda') }}";
    }
}
</script>

<style>
/* Estilos adicionales para mejorar la apariencia */
.btn-group .btn {
    margin-right: 2px;
}

.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.table th {
    border-top: none;
    font-weight: 600;
}

.progress {
    border-radius: 10px;
}

.badge {
    font-size: 0.75em;
}

/* Estilo para canvas con mensaje SIN DATOS */
canvas {
    border: 1px solid #e9ecef;
    border-radius: 4px;
    background-color: #f8f9fa;
}

/* Mejorar la visualizaci√≥n de las gr√°ficas en m√≥viles */
@media (max-width: 768px) {
    .col-md-4 {
        margin-bottom: 20px;
    }
}

/* Estilos para gr√°ficas ampliadas */
.grafica-container:hover {
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    transition: box-shadow 0.3s ease;
}

.modal-xl {
    max-width: 90%;
}

.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%);
}
</style>
{% endblock %}